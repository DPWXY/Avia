import { CloudFormationServiceException, DescribeStacksCommand, GetTemplateSummaryCommand, } from '@aws-sdk/client-cloudformation';
import { backendOutputStackMetadataSchema, } from '@aws-amplify/backend-output-schemas';
import { BackendOutputClientError, BackendOutputClientErrorType, } from './index.js';
/**
 * Gets Amplify backend outputs from stack metadata and outputs
 */
export class StackMetadataBackendOutputRetrievalStrategy {
    cfnClient;
    stackNameResolver;
    /**
     * Instantiate with a CloudFormationClient and a StackNameResolver
     */
    constructor(cfnClient, stackNameResolver) {
        this.cfnClient = cfnClient;
        this.stackNameResolver = stackNameResolver;
    }
    /**
     * Resolves the stackName, then queries CFN for the stack metadata and outputs
     *
     * It combines the metadata and outputs to reconstruct the data object that was provided by the Amplify constructs when writing the output.
     * Except now the data contains the resolved values of the deployed resources rather than CFN references
     */
    fetchBackendOutput = async () => {
        const stackName = await this.stackNameResolver.resolveMainStackName();
        let metadataObject;
        try {
            // GetTemplateSummary includes the template metadata as a string
            const templateSummary = await this.cfnClient.send(new GetTemplateSummaryCommand({ StackName: stackName }));
            if (typeof templateSummary.Metadata !== 'string') {
                throw new BackendOutputClientError(BackendOutputClientErrorType.METADATA_RETRIEVAL_ERROR, 'Stack template metadata is not a string');
            }
            metadataObject = JSON.parse(templateSummary.Metadata);
        }
        catch (error) {
            if (error instanceof CloudFormationServiceException &&
                error.message.startsWith('Stack with id') &&
                error.message.endsWith('does not exist')) {
                throw new BackendOutputClientError(BackendOutputClientErrorType.NO_STACK_FOUND, `Stack with id ${stackName} does not exist`);
            }
            if (error instanceof CloudFormationServiceException &&
                ['ExpiredToken', 'InvalidClientTokenId'].includes(error.name)) {
                throw new BackendOutputClientError(BackendOutputClientErrorType.CREDENTIALS_ERROR, error.message);
            }
            if (error instanceof CloudFormationServiceException &&
                error.name === 'AccessDenied') {
                throw new BackendOutputClientError(BackendOutputClientErrorType.ACCESS_DENIED, error.message);
            }
            throw error;
        }
        const filteredMetadataObject = this.filterBackendOutputEntryStackMetadata(metadataObject);
        // parse and validate the metadata object
        const backendOutputMetadata = backendOutputStackMetadataSchema.parse(filteredMetadataObject);
        // DescribeStacks includes the template output
        const stackDescription = await this.cfnClient.send(new DescribeStacksCommand({ StackName: stackName }));
        const outputs = stackDescription?.Stacks?.[0]?.Outputs;
        if (stackDescription.Stacks?.[0].StackStatus?.endsWith('_IN_PROGRESS')) {
            const deploymentType = stackDescription.Stacks?.[0].Tags?.find((tag) => tag.Key === 'amplify:deployment-type')?.Value ?? 'sandbox';
            throw new BackendOutputClientError(BackendOutputClientErrorType.DEPLOYMENT_IN_PROGRESS, `This ${deploymentType} deployment is in progress. Re-run this command once the deployment completes.`);
        }
        if (outputs === undefined) {
            throw new BackendOutputClientError(BackendOutputClientErrorType.NO_OUTPUTS_FOUND, 'Stack outputs are undefined');
        }
        // outputs is a list of output entries. here we turn that into a Record<name, value> object
        const stackOutputRecord = outputs
            .filter((output) => !!output.OutputValue && !!output.OutputKey)
            .reduce((accumulator, outputEntry) => ({
            ...accumulator,
            // it's safe to disable this rule because we've already filtered out potentially undefined outputs
            // eslint-disable-next-line @typescript-eslint/no-non-null-assertion
            [outputEntry.OutputKey]: outputEntry.OutputValue,
        }), {});
        // now we iterate over the metadata entries and reconstruct the data object based on the stackOutputs that each construct package set
        const result = {};
        Object.entries(backendOutputMetadata).forEach(([outputKeyName, entry]) => {
            const outputData = entry.stackOutputs.reduce((accumulator, outputName) => {
                if (stackOutputRecord[outputName] === undefined ||
                    stackOutputRecord[outputName] === '') {
                    return accumulator;
                }
                return {
                    ...accumulator,
                    [outputName]: stackOutputRecord[outputName],
                };
            }, {});
            result[outputKeyName] = {
                version: entry.version,
                payload: outputData,
            };
        });
        return result;
    };
    /**
     * Filter out stack metadata entries that do not pertain to backend outputs
     */
    filterBackendOutputEntryStackMetadata(metadata) {
        return Object.fromEntries(Object.entries(metadata).filter(([, value]) => this.isBackendOutputEntryStackMetadata(value)));
    }
    /**
     * Type predicate to determine if stack metadata entry is like a backend output entry.
     * Zod parsing validation will handle stricter type checking
     */
    isBackendOutputEntryStackMetadata(obj) {
        return (!!obj &&
            typeof obj === 'object' &&
            'version' in obj &&
            'stackOutputs' in obj);
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic3RhY2tfbWV0YWRhdGFfb3V0cHV0X3JldHJpZXZhbF9zdHJhdGVneS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uL3NyYy9zdGFja19tZXRhZGF0YV9vdXRwdXRfcmV0cmlldmFsX3N0cmF0ZWd5LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiJBQUFBLE9BQU8sRUFFTCw4QkFBOEIsRUFDOUIscUJBQXFCLEVBQ3JCLHlCQUF5QixHQUMxQixNQUFNLGdDQUFnQyxDQUFDO0FBTXhDLE9BQU8sRUFFTCxnQ0FBZ0MsR0FDakMsTUFBTSxxQ0FBcUMsQ0FBQztBQUM3QyxPQUFPLEVBQ0wsd0JBQXdCLEVBQ3hCLDRCQUE0QixHQUM3QixNQUFNLFlBQVksQ0FBQztBQUVwQjs7R0FFRztBQUNILE1BQU0sT0FBTywyQ0FBMkM7SUFPbkM7SUFDQTtJQUxuQjs7T0FFRztJQUNILFlBQ21CLFNBQStCLEVBQy9CLGlCQUF3QztRQUR4QyxjQUFTLEdBQVQsU0FBUyxDQUFzQjtRQUMvQixzQkFBaUIsR0FBakIsaUJBQWlCLENBQXVCO0lBQ3hELENBQUM7SUFFSjs7Ozs7T0FLRztJQUNILGtCQUFrQixHQUFHLEtBQUssSUFBNEIsRUFBRTtRQUN0RCxNQUFNLFNBQVMsR0FBRyxNQUFNLElBQUksQ0FBQyxpQkFBaUIsQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1FBRXRFLElBQUksY0FBYyxDQUFDO1FBRW5CLElBQUk7WUFDRixnRUFBZ0U7WUFDaEUsTUFBTSxlQUFlLEdBQUcsTUFBTSxJQUFJLENBQUMsU0FBUyxDQUFDLElBQUksQ0FDL0MsSUFBSSx5QkFBeUIsQ0FBQyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsQ0FBQyxDQUN4RCxDQUFDO1lBRUYsSUFBSSxPQUFPLGVBQWUsQ0FBQyxRQUFRLEtBQUssUUFBUSxFQUFFO2dCQUNoRCxNQUFNLElBQUksd0JBQXdCLENBQ2hDLDRCQUE0QixDQUFDLHdCQUF3QixFQUNyRCx5Q0FBeUMsQ0FDMUMsQ0FBQzthQUNIO1lBRUQs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YyxJQUFJLEdBQUcsQ0FDdEIsQ0FBQztJQUNKLENBQUM7Q0FDRiIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG4gIENsb3VkRm9ybWF0aW9uQ2xpZW50LFxuICBDbG91ZEZvcm1hdGlvblNlcnZpY2VFeGNlcHRpb24sXG4gIERlc2NyaWJlU3RhY2tzQ29tbWFuZCxcbiAgR2V0VGVtcGxhdGVTdW1tYXJ5Q29tbWFuZCxcbn0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWNsb3VkZm9ybWF0aW9uJztcbmltcG9ydCB7XG4gIEJhY2tlbmRPdXRwdXQsXG4gIEJhY2tlbmRPdXRwdXRSZXRyaWV2YWxTdHJhdGVneSxcbiAgTWFpblN0YWNrTmFtZVJlc29sdmVyLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvcGx1Z2luLXR5cGVzJztcbmltcG9ydCB7XG4gIEJhY2tlbmRPdXRwdXRFbnRyeVN0YWNrTWV0YWRhdGEsXG4gIGJhY2tlbmRPdXRwdXRTdGFja01ldGFkYXRhU2NoZW1hLFxufSBmcm9tICdAYXdzLWFtcGxpZnkvYmFja2VuZC1vdXRwdXQtc2NoZW1hcyc7XG5pbXBvcnQge1xuICBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IsXG4gIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvclR5cGUsXG59IGZyb20gJy4vaW5kZXguanMnO1xuXG4vKipcbiAqIEdldHMgQW1wbGlmeSBiYWNrZW5kIG91dHB1dHMgZnJvbSBzdGFjayBtZXRhZGF0YSBhbmQgb3V0cHV0c1xuICovXG5leHBvcnQgY2xhc3MgU3RhY2tNZXRhZGF0YUJhY2tlbmRPdXRwdXRSZXRyaWV2YWxTdHJhdGVneVxuICBpbXBsZW1lbnRzIEJhY2tlbmRPdXRwdXRSZXRyaWV2YWxTdHJhdGVneVxue1xuICAvKipcbiAgICogSW5zdGFudGlhdGUgd2l0aCBhIENsb3VkRm9ybWF0aW9uQ2xpZW50IGFuZCBhIFN0YWNrTmFtZVJlc29sdmVyXG4gICAqL1xuICBjb25zdHJ1Y3RvcihcbiAgICBwcml2YXRlIHJlYWRvbmx5IGNmbkNsaWVudDogQ2xvdWRGb3JtYXRpb25DbGllbnQsXG4gICAgcHJpdmF0ZSByZWFkb25seSBzdGFja05hbWVSZXNvbHZlcjogTWFpblN0YWNrTmFtZVJlc29sdmVyXG4gICkge31cblxuICAvKipcbiAgICogUmVzb2x2ZXMgdGhlIHN0YWNrTmFtZSwgdGhlbiBxdWVyaWVzIENGTiBmb3IgdGhlIHN0YWNrIG1ldGFkYXRhIGFuZCBvdXRwdXRzXG4gICAqXG4gICAqIEl0IGNvbWJpbmVzIHRoZSBtZXRhZGF0YSBhbmQgb3V0cHV0cyB0byByZWNvbnN0cnVjdCB0aGUgZGF0YSBvYmplY3QgdGhhdCB3YXMgcHJvdmlkZWQgYnkgdGhlIEFtcGxpZnkgY29uc3RydWN0cyB3aGVuIHdyaXRpbmcgdGhlIG91dHB1dC5cbiAgICogRXhjZXB0IG5vdyB0aGUgZGF0YSBjb250YWlucyB0aGUgcmVzb2x2ZWQgdmFsdWVzIG9mIHRoZSBkZXBsb3llZCByZXNvdXJjZXMgcmF0aGVyIHRoYW4gQ0ZOIHJlZmVyZW5jZXNcbiAgICovXG4gIGZldGNoQmFja2VuZE91dHB1dCA9IGFzeW5jICgpOiBQcm9taXNlPEJhY2tlbmRPdXRwdXQ+ID0+IHtcbiAgICBjb25zdCBzdGFja05hbWUgPSBhd2FpdCB0aGlzLnN0YWNrTmFtZVJlc29sdmVyLnJlc29sdmVNYWluU3RhY2tOYW1lKCk7XG5cbiAgICBsZXQgbWV0YWRhdGFPYmplY3Q7XG5cbiAgICB0cnkge1xuICAgICAgLy8gR2V0VGVtcGxhdGVTdW1tYXJ5IGluY2x1ZGVzIHRoZSB0ZW1wbGF0ZSBtZXRhZGF0YSBhcyBhIHN0cmluZ1xuICAgICAgY29uc3QgdGVtcGxhdGVTdW1tYXJ5ID0gYXdhaXQgdGhpcy5jZm5DbGllbnQuc2VuZChcbiAgICAgICAgbmV3IEdldFRlbXBsYXRlU3VtbWFyeUNvbW1hbmQoeyBTdGFja05hbWU6IHN0YWNrTmFtZSB9KVxuICAgICAgKTtcblxuICAgICAgaWYgKHR5cGVvZiB0ZW1wbGF0ZVN1bW1hcnkuTWV0YWRhdGEgIT09ICdzdHJpbmcnKSB7XG4gICAgICAgIHRocm93IG5ldyBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IoXG4gICAgICAgICAgQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5NRVRBREFUQV9SRVRSSUVWQUxfRVJST1IsXG4gICAgICAgICAgJ1N0YWNrIHRlbXBsYXRlIG1ldGFkYXRhIGlzIG5vdCBhIHN0cmluZydcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgbWV0YWRhdGFPYmplY3QgPSBKU09OLnBhcnNlKHRlbXBsYXRlU3VtbWFyeS5NZXRhZGF0YSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGlmIChcbiAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBDbG91ZEZvcm1hdGlvblNlcnZpY2VFeGNlcHRpb24gJiZcbiAgICAgICAgZXJyb3IubWVzc2FnZS5zdGFydHNXaXRoKCdTdGFjayB3aXRoIGlkJykgJiZcbiAgICAgICAgZXJyb3IubWVzc2FnZS5lbmRzV2l0aCgnZG9lcyBub3QgZXhpc3QnKVxuICAgICAgKSB7XG4gICAgICAgIHRocm93IG5ldyBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IoXG4gICAgICAgICAgQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5OT19TVEFDS19GT1VORCxcbiAgICAgICAgICBgU3RhY2sgd2l0aCBpZCAke3N0YWNrTmFtZX0gZG9lcyBub3QgZXhpc3RgXG4gICAgICAgICk7XG4gICAgICB9XG4gICAgICBpZiAoXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgQ2xvdWRGb3JtYXRpb25TZXJ2aWNlRXhjZXB0aW9uICYmXG4gICAgICAgIFsnRXhwaXJlZFRva2VuJywgJ0ludmFsaWRDbGllbnRUb2tlbklkJ10uaW5jbHVkZXMoZXJyb3IubmFtZSlcbiAgICAgICkge1xuICAgICAgICB0aHJvdyBuZXcgQmFja2VuZE91dHB1dENsaWVudEVycm9yKFxuICAgICAgICAgIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvclR5cGUuQ1JFREVOVElBTFNfRVJST1IsXG4gICAgICAgICAgZXJyb3IubWVzc2FnZVxuICAgICAgICApO1xuICAgICAgfVxuICAgICAgaWYgKFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIENsb3VkRm9ybWF0aW9uU2VydmljZUV4Y2VwdGlvbiAmJlxuICAgICAgICBlcnJvci5uYW1lID09PSAnQWNjZXNzRGVuaWVkJ1xuICAgICAgKSB7XG4gICAgICAgIHRocm93IG5ldyBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IoXG4gICAgICAgICAgQmFja2VuZE91dHB1dENsaWVudEVycm9yVHlwZS5BQ0NFU1NfREVOSUVELFxuICAgICAgICAgIGVycm9yLm1lc3NhZ2VcbiAgICAgICAgKTtcbiAgICAgIH1cblxuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuXG4gICAgY29uc3QgZmlsdGVyZWRNZXRhZGF0YU9iamVjdCA9XG4gICAgICB0aGlzLmZpbHRlckJhY2tlbmRPdXRwdXRFbnRyeVN0YWNrTWV0YWRhdGEobWV0YWRhdGFPYmplY3QpO1xuXG4gICAgLy8gcGFyc2UgYW5kIHZhbGlkYXRlIHRoZSBtZXRhZGF0YSBvYmplY3RcbiAgICBjb25zdCBiYWNrZW5kT3V0cHV0TWV0YWRhdGEgPSBiYWNrZW5kT3V0cHV0U3RhY2tNZXRhZGF0YVNjaGVtYS5wYXJzZShcbiAgICAgIGZpbHRlcmVkTWV0YWRhdGFPYmplY3RcbiAgICApO1xuXG4gICAgLy8gRGVzY3JpYmVTdGFja3MgaW5jbHVkZXMgdGhlIHRlbXBsYXRlIG91dHB1dFxuICAgIGNvbnN0IHN0YWNrRGVzY3JpcHRpb24gPSBhd2FpdCB0aGlzLmNmbkNsaWVudC5zZW5kKFxuICAgICAgbmV3IERlc2NyaWJlU3RhY2tzQ29tbWFuZCh7IFN0YWNrTmFtZTogc3RhY2tOYW1lIH0pXG4gICAgKTtcblxuICAgIGNvbnN0IG91dHB1dHMgPSBzdGFja0Rlc2NyaXB0aW9uPy5TdGFja3M/LlswXT8uT3V0cHV0cztcbiAgICBpZiAoc3RhY2tEZXNjcmlwdGlvbi5TdGFja3M/LlswXS5TdGFja1N0YXR1cz8uZW5kc1dpdGgoJ19JTl9QUk9HUkVTUycpKSB7XG4gICAgICBjb25zdCBkZXBsb3ltZW50VHlwZSA9XG4gICAgICAgIHN0YWNrRGVzY3JpcHRpb24uU3RhY2tzPy5bMF0uVGFncz8uZmluZChcbiAgICAgICAgICAodGFnKSA9PiB0YWcuS2V5ID09PSAnYW1wbGlmeTpkZXBsb3ltZW50LXR5cGUnXG4gICAgICAgICk/LlZhbHVlID8/ICdzYW5kYm94JztcbiAgICAgIHRocm93IG5ldyBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3IoXG4gICAgICAgIEJhY2tlbmRPdXRwdXRDbGllbnRFcnJvclR5cGUuREVQTE9ZTUVOVF9JTl9QUk9HUkVTUyxcbiAgICAgICAgYFRoaXMgJHtkZXBsb3ltZW50VHlwZX0gZGVwbG95bWVudCBpcyBpbiBwcm9ncmVzcy4gUmUtcnVuIHRoaXMgY29tbWFuZCBvbmNlIHRoZSBkZXBsb3ltZW50IGNvbXBsZXRlcy5gXG4gICAgICApO1xuICAgIH1cbiAgICBpZiAob3V0cHV0cyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0aHJvdyBuZXcgQmFja2VuZE91dHB1dENsaWVudEVycm9yKFxuICAgICAgICBCYWNrZW5kT3V0cHV0Q2xpZW50RXJyb3JUeXBlLk5PX09VVFBVVFNfRk9VTkQsXG4gICAgICAgICdTdGFjayBvdXRwdXRzIGFyZSB1bmRlZmluZWQnXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIG91dHB1dHMgaXMgYSBsaXN0IG9mIG91dHB1dCBlbnRyaWVzLiBoZXJlIHdlIHR1cm4gdGhhdCBpbnRvIGEgUmVjb3JkPG5hbWUsIHZhbHVlPiBvYmplY3RcbiAgICBjb25zdCBzdGFja091dHB1dFJlY29yZCA9IG91dHB1dHNcbiAgICAgIC5maWx0ZXIoKG91dHB1dCkgPT4gISFvdXRwdXQuT3V0cHV0VmFsdWUgJiYgISFvdXRwdXQuT3V0cHV0S2V5KVxuICAgICAgLnJlZHVjZShcbiAgICAgICAgKGFjY3VtdWxhdG9yLCBvdXRwdXRFbnRyeSkgPT4gKHtcbiAgICAgICAgICAuLi5hY2N1bXVsYXRvcixcbiAgICAgICAgICAvLyBpdCdzIHNhZmUgdG8gZGlzYWJsZSB0aGlzIHJ1bGUgYmVjYXVzZSB3ZSd2ZSBhbHJlYWR5IGZpbHRlcmVkIG91dCBwb3RlbnRpYWxseSB1bmRlZmluZWQgb3V0cHV0c1xuICAgICAgICAgIC8vIGVzbGludC1kaXNhYmxlLW5leHQtbGluZSBAdHlwZXNjcmlwdC1lc2xpbnQvbm8tbm9uLW51bGwtYXNzZXJ0aW9uXG4gICAgICAgICAgW291dHB1dEVudHJ5Lk91dHB1dEtleSFdOiBvdXRwdXRFbnRyeS5PdXRwdXRWYWx1ZSEsXG4gICAgICAgIH0pLFxuICAgICAgICB7fSBhcyBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+XG4gICAgICApO1xuXG4gICAgLy8gbm93IHdlIGl0ZXJhdGUgb3ZlciB0aGUgbWV0YWRhdGEgZW50cmllcyBhbmQgcmVjb25zdHJ1Y3QgdGhlIGRhdGEgb2JqZWN0IGJhc2VkIG9uIHRoZSBzdGFja091dHB1dHMgdGhhdCBlYWNoIGNvbnN0cnVjdCBwYWNrYWdlIHNldFxuICAgIGNvbnN0IHJlc3VsdDogQmFja2VuZE91dHB1dCA9IHt9O1xuICAgIE9iamVjdC5lbnRyaWVzKGJhY2tlbmRPdXRwdXRNZXRhZGF0YSkuZm9yRWFjaCgoW291dHB1dEtleU5hbWUsIGVudHJ5XSkgPT4ge1xuICAgICAgY29uc3Qgb3V0cHV0RGF0YSA9IGVudHJ5LnN0YWNrT3V0cHV0cy5yZWR1Y2UoXG4gICAgICAgIChhY2N1bXVsYXRvciwgb3V0cHV0TmFtZSkgPT4ge1xuICAgICAgICAgIGlmIChcbiAgICAgICAgICAgIHN0YWNrT3V0cHV0UmVjb3JkW291dHB1dE5hbWVdID09PSB1bmRlZmluZWQgfHxcbiAgICAgICAgICAgIHN0YWNrT3V0cHV0UmVjb3JkW291dHB1dE5hbWVdID09PSAnJ1xuICAgICAgICAgICkge1xuICAgICAgICAgICAgcmV0dXJuIGFjY3VtdWxhdG9yO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgLi4uYWNjdW11bGF0b3IsXG4gICAgICAgICAgICBbb3V0cHV0TmFtZV06IHN0YWNrT3V0cHV0UmVjb3JkW291dHB1dE5hbWVdLFxuICAgICAgICAgIH07XG4gICAgICAgIH0sXG4gICAgICAgIHt9IGFzIFJlY29yZDxzdHJpbmcsIHN0cmluZz5cbiAgICAgICk7XG4gICAgICByZXN1bHRbb3V0cHV0S2V5TmFtZV0gPSB7XG4gICAgICAgIHZlcnNpb246IGVudHJ5LnZlcnNpb24sXG4gICAgICAgIHBheWxvYWQ6IG91dHB1dERhdGEsXG4gICAgICB9O1xuICAgIH0pO1xuICAgIHJldHVybiByZXN1bHQ7XG4gIH07XG5cbiAgLyoqXG4gICAqIEZpbHRlciBvdXQgc3RhY2sgbWV0YWRhdGEgZW50cmllcyB0aGF0IGRvIG5vdCBwZXJ0YWluIHRvIGJhY2tlbmQgb3V0cHV0c1xuICAgKi9cbiAgcHJpdmF0ZSBmaWx0ZXJCYWNrZW5kT3V0cHV0RW50cnlTdGFja01ldGFkYXRhPFxuICAgIFQgZXh0ZW5kcyBSZWNvcmQ8c3RyaW5nLCB1bmtub3duPlxuICA+KG1ldGFkYXRhOiBUKSB7XG4gICAgcmV0dXJuIE9iamVjdC5mcm9tRW50cmllcyhcbiAgICAgIE9iamVjdC5lbnRyaWVzKG1ldGFkYXRhKS5maWx0ZXIoKFssIHZhbHVlXSkgPT5cbiAgICAgICAgdGhpcy5pc0JhY2tlbmRPdXRwdXRFbnRyeVN0YWNrTWV0YWRhdGEodmFsdWUpXG4gICAgICApXG4gICAgKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBUeXBlIHByZWRpY2F0ZSB0byBkZXRlcm1pbmUgaWYgc3RhY2sgbWV0YWRhdGEgZW50cnkgaXMgbGlrZSBhIGJhY2tlbmQgb3V0cHV0IGVudHJ5LlxuICAgKiBab2QgcGFyc2luZyB2YWxpZGF0aW9uIHdpbGwgaGFuZGxlIHN0cmljdGVyIHR5cGUgY2hlY2tpbmdcbiAgICovXG4gIHByaXZhdGUgaXNCYWNrZW5kT3V0cHV0RW50cnlTdGFja01ldGFkYXRhKFxuICAgIG9iajogdW5rbm93blxuICApOiBvYmogaXMgQmFja2VuZE91dHB1dEVudHJ5U3RhY2tNZXRhZGF0YSB7XG4gICAgcmV0dXJuIChcbiAgICAgICEhb2JqICYmXG4gICAgICB0eXBlb2Ygb2JqID09PSAnb2JqZWN0JyAmJlxuICAgICAgJ3ZlcnNpb24nIGluIG9iaiAmJlxuICAgICAgJ3N0YWNrT3V0cHV0cycgaW4gb2JqXG4gICAgKTtcbiAgfVxufVxuIl19